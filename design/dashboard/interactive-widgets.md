# Interactive Widgets — Canonical Specification

**Version:** 1.0  
**Date:** February 11, 2026  
**Status:** Design  
**Consolidates:** `design/agents/widget-agent.md`, `deliverables/kira-dashboard-chat-ui-design.md` §4

---

## Overview

Widgets are structured, interactive UI components rendered inline in the chat. They are generated by the **Widget Agent** (a fast, cheap, single-turn specialist) and rendered by the Dashboard in sandboxed iframes.

---

## 1. Invocation Protocol

```
User message
    │
    ▼
Main Agent (detects widget need)
    │
    ├── Explicit: user wrote "@widget ..." directive
    │   └── Main agent extracts type + gathers data
    │
    └── Auto-detect: main agent decides visual would help
        └── Pattern matching or LLM judgment
    │
    ▼
Spawn Widget Agent (flash model, <10s, 1 turn)
    │
    ▼
Widget Agent returns JSON (matches schema)
    │
    ▼
Main Agent embeds JSON in HTML comment:
    <!-- widget:bar_chart:v1 {"widget":"bar_chart",...} -->
    │
    ▼
Dashboard parser detects HTML comment → renders iframe
```

### Auto-Detection Triggers

| Widget | Pattern |
|--------|---------|
| bar_chart | "chart", "graph", "bar", "histogram" + "show/display/visualize" |
| table | "table", "compare", "comparison", "vs" |
| timeline | "timeline", "history", "chronological" |
| kanban | "board", "kanban", "tasks", "progress" |
| status_board | "status", "health", "dashboard", "overview" |
| decision_cards | Agent detects 2-6 options user must choose between |

---

## 2. Widget Types

### 2.1 Decision Cards

User must choose between 2-6 options. Cards show title, description, key metrics. Hover expands details. Click selects.

**Use case:** "Which approach: A, B, or C?"

### 2.2 Comparison Table

Side-by-side feature/attribute comparison with colored indicators (✅/❌/⚠️).

**Use case:** "Compare these three frameworks"

### 2.3 Chart (Bar/Line/Pie)

Data visualization using Chart.js or lightweight SVG rendering.

**Use case:** "Show my git commits this week"

### 2.4 Progress Tracker

Multi-step progress with current position, completed/pending states, and optional percentages.

**Use case:** "Show project progress"

### 2.5 Timeline

Vertical chronological event list with icons, dates, descriptions.

**Use case:** "Show the history of this feature"

### 2.6 Kanban

Columnar board with draggable cards. Columns represent states (Todo/In Progress/Done).

**Use case:** "Show my tasks as a board"

### 2.7 Poll

Vote on options. Shows results as horizontal bars after voting.

**Use case:** "Quick poll: which name do you prefer?"

### 2.8 File Preview

Rich preview of a file (markdown rendered, code highlighted, images shown, PDFs embedded).

**Use case:** Agent references a file and wants to show contents inline.

---

## 3. JSON Schemas

### 3.1 Decision Cards

```json
{
  "$id": "widget:decision_cards:v1",
  "properties": {
    "widget": { "const": "decision_cards" },
    "version": { "const": "1" },
    "data": {
      "type": "object",
      "required": ["question", "options"],
      "properties": {
        "question": { "type": "string" },
        "options": {
          "type": "array",
          "minItems": 2,
          "maxItems": 6,
          "items": {
            "type": "object",
            "required": ["id", "title"],
            "properties": {
              "id": { "type": "string" },
              "title": { "type": "string" },
              "description": { "type": "string" },
              "icon": { "type": "string" },
              "metrics": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "label": { "type": "string" },
                    "value": { "type": "string" }
                  }
                }
              },
              "pros": { "type": "array", "items": { "type": "string" } },
              "cons": { "type": "array", "items": { "type": "string" } }
            }
          }
        }
      }
    }
  }
}
```

### 3.2 Comparison Table

```json
{
  "$id": "widget:comparison_table:v1",
  "properties": {
    "widget": { "const": "comparison_table" },
    "data": {
      "type": "object",
      "required": ["attributes", "items"],
      "properties": {
        "title": { "type": "string" },
        "attributes": {
          "type": "array",
          "items": { "type": "string" }
        },
        "items": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "values"],
            "properties": {
              "name": { "type": "string" },
              "values": {
                "type": "object",
                "additionalProperties": {
                  "oneOf": [
                    { "type": "string" },
                    { "type": "boolean" },
                    { "type": "number" }
                  ]
                }
              }
            }
          }
        }
      }
    }
  }
}
```

### 3.3 Chart (Bar)

```json
{
  "$id": "widget:bar_chart:v1",
  "properties": {
    "widget": { "const": "bar_chart" },
    "version": { "const": "1" },
    "data": {
      "type": "object",
      "required": ["labels", "datasets"],
      "properties": {
        "labels": { "type": "array", "items": { "type": "string" } },
        "datasets": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["values"],
            "properties": {
              "label": { "type": "string" },
              "values": { "type": "array", "items": { "type": "number" } },
              "color": { "type": "string" }
            }
          }
        }
      }
    },
    "options": {
      "properties": {
        "title": { "type": "string" },
        "x_axis_label": { "type": "string" },
        "y_axis_label": { "type": "string" },
        "stacked": { "type": "boolean" },
        "horizontal": { "type": "boolean" }
      }
    }
  }
}
```

### 3.4 Progress Tracker

```json
{
  "$id": "widget:progress_tracker:v1",
  "properties": {
    "widget": { "const": "progress_tracker" },
    "data": {
      "type": "object",
      "required": ["steps"],
      "properties": {
        "title": { "type": "string" },
        "currentStep": { "type": "number" },
        "steps": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["label", "status"],
            "properties": {
              "label": { "type": "string" },
              "status": { "enum": ["completed", "current", "pending", "skipped"] },
              "detail": { "type": "string" },
              "percent": { "type": "number" }
            }
          }
        }
      }
    }
  }
}
```

### 3.5 Timeline

```json
{
  "$id": "widget:timeline:v1",
  "properties": {
    "widget": { "const": "timeline" },
    "data": {
      "type": "object",
      "required": ["events"],
      "properties": {
        "title": { "type": "string" },
        "events": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["date", "title"],
            "properties": {
              "date": { "type": "string" },
              "title": { "type": "string" },
              "description": { "type": "string" },
              "icon": { "type": "string" },
              "color": { "type": "string" }
            }
          }
        }
      }
    }
  }
}
```

### 3.6 Kanban

```json
{
  "$id": "widget:kanban:v1",
  "properties": {
    "widget": { "const": "kanban" },
    "data": {
      "type": "object",
      "required": ["columns"],
      "properties": {
        "title": { "type": "string" },
        "columns": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["title", "cards"],
            "properties": {
              "title": { "type": "string" },
              "color": { "type": "string" },
              "cards": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["title"],
                  "properties": {
                    "id": { "type": "string" },
                    "title": { "type": "string" },
                    "description": { "type": "string" },
                    "tags": { "type": "array", "items": { "type": "string" } },
                    "priority": { "enum": ["low", "medium", "high"] },
                    "assignee": { "type": "string" }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
```

### 3.7 Poll

```json
{
  "$id": "widget:poll:v1",
  "properties": {
    "widget": { "const": "poll" },
    "data": {
      "type": "object",
      "required": ["question", "options"],
      "properties": {
        "question": { "type": "string" },
        "options": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "label"],
            "properties": {
              "id": { "type": "string" },
              "label": { "type": "string" },
              "votes": { "type": "number", "default": 0 }
            }
          }
        },
        "multiSelect": { "type": "boolean", "default": false }
      }
    }
  }
}
```

### 3.8 File Preview

```json
{
  "$id": "widget:file_preview:v1",
  "properties": {
    "widget": { "const": "file_preview" },
    "data": {
      "type": "object",
      "required": ["path"],
      "properties": {
        "path": { "type": "string" },
        "content": { "type": "string" },
        "language": { "type": "string" },
        "mimeType": { "type": "string" },
        "highlights": { "type": "array", "items": { "type": "number" } }
      }
    }
  }
}
```

---

## 4. Rendering Architecture

### Sandboxed Iframe

Each widget renders in an iframe with:

```html
<iframe
  sandbox="allow-scripts"
  srcdoc="..."
  style="width: 100%; border: none;"
/>
```

**Security:** No `allow-same-origin`, no `allow-forms`, no `allow-popups`. The widget cannot access the parent page's DOM, cookies, or storage.

### Rendering Pipeline

```
HTML comment in message
    │
    ▼
Dashboard message parser (regex: /<!-- widget:(\w+):v(\d+) ({.*}) -->/)
    │
    ▼
Schema validation (reject malformed JSON)
    │
    ▼
Widget renderer component
    │
    ├── Load widget template (HTML + JS + CSS)
    ├── Inject data as JSON
    ├── Apply theme variables
    │
    ▼
Render in sandboxed iframe
    │
    ▼
Auto-resize iframe height (postMessage → parent)
```

### Auto-Resize

Widget posts its height to parent:
```javascript
// Inside widget iframe
const observer = new ResizeObserver(() => {
  parent.postMessage({ type: 'widget:resize', height: document.body.scrollHeight }, '*');
});
observer.observe(document.body);
```

Parent listens and resizes iframe:
```javascript
window.addEventListener('message', (e) => {
  if (e.data.type === 'widget:resize') {
    iframe.style.height = e.data.height + 'px';
  }
});
```

---

## 5. Design System

### CSS Variables (shared with main dashboard)

```css
:root {
  /* Colors */
  --bg-primary: #0f0f0f;
  --bg-secondary: #1a1a1a;
  --bg-elevated: #242424;
  --text-primary: #e0e0e0;
  --text-secondary: #888;
  --accent: #6c5ce7;
  --accent-hover: #7c6cf7;
  --success: #00b894;
  --warning: #fdcb6e;
  --danger: #e17055;

  /* Spacing */
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;

  /* Typography */
  --font-body: 'Inter', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --font-size-sm: 13px;
  --font-size-md: 15px;

  /* Borders */
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --border-subtle: 1px solid rgba(255,255,255,0.06);
}
```

Theme injected into iframe via `<style>` block. Light theme overrides these variables.

### Animations

| Animation | Use | CSS |
|-----------|-----|-----|
| Fade-in | Widget appears | `opacity 0→1, 300ms ease` |
| Slide-up | Cards/items enter | `translateY(8px→0), 200ms ease` |
| Hover lift | Decision cards | `translateY(-2px), box-shadow increase` |
| Pulse | Loading states | `opacity 0.5↔1, 1.5s infinite` |
| Bar grow | Chart bars | `scaleY(0→1), 400ms ease-out` |

---

## 6. Interaction Callbacks

Widgets communicate user actions to the chat via `postMessage`:

### Widget → Parent

```javascript
// User clicked decision card "option_a"
parent.postMessage({
  type: 'widget:action',
  widget: 'decision_cards',
  action: 'select',
  payload: { optionId: 'option_a', label: 'HRV Only' }
}, '*');
```

### Parent → Chat

The dashboard receives the postMessage and injects a user message:

```
User selected: **HRV Only** (from decision card)
```

This message goes through `POST /api/chat/send` as if the user typed it, allowing the agent to respond naturally.

### Supported Actions

| Widget | Action | Payload |
|--------|--------|---------|
| decision_cards | `select` | `{ optionId, label }` |
| comparison_table | `sort` | `{ column, direction }` |
| kanban | `move` | `{ cardId, fromColumn, toColumn }` |
| poll | `vote` | `{ optionId }` |
| file_preview | `open` | `{ path }` |

---

## 7. Platform Fallback

When widgets can't render (Telegram, Discord, CLI), the main agent generates a text fallback:

| Widget | Fallback |
|--------|----------|
| decision_cards | Numbered list with descriptions, "Reply 1/2/3 to choose" |
| comparison_table | Markdown table (or bullet list for Discord) |
| bar_chart | ASCII bar chart |
| progress_tracker | Step list with ✅/⏳/○ markers |
| timeline | Date-prefixed list |
| kanban | Grouped list by column |
| poll | Numbered options, "Reply with number to vote" |
| file_preview | Code block with first 50 lines |

Fallback generation is handled by `generateTextFallback()` in the main agent, not the Widget Agent.

---

## 8. Widget Agent Configuration

| Property | Value |
|----------|-------|
| **Model priority** | gemini-2.0-flash → claude-haiku-3 → claude-sonnet |
| **Timeout** | 10 seconds |
| **Max turns** | 1 |
| **Max tokens** | 5000 |
| **Target cost** | <$0.005/call |
| **Success rate target** | >95% |
| **Output format** | Raw JSON only (no markdown, no explanation) |
| **Fallback** | Main agent generates text representation |
